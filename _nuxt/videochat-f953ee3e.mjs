import{e as ie,z as Je,Q as S,o as w,a as T,b as l,t as ae,U as Ce,V as De,P as u,u as N,s as Ge,r as Ke,X as x,f as c,w as I,_ as Se,af as ye,ag as Qe,a4 as Xe,A as Ye,y as he,j as Ze,ae as et,N as j,c as ee,W as $,k as tt,ah as at,a5 as it,Y as ke}from"./entry-c501f1fd.mjs";import{_ as Ve}from"./plugin-vue_export-helper-84c1d017.mjs";import{b as ot,c as st,d as nt,e as lt,f as rt}from"./index-7ee5a4eb.mjs";import{u as ct}from"./useSeo-61e4856d.mjs";const dt={class:"flex flex-col w-full px-5"},ut={class:"text-vanilla-yellow border-b-light-50 border-solid border-b-[2.5px]"},ht=["for"],vt=ie({__name:"RadioList",props:{title:null,items:null,modelValue:null,disabled:{type:Boolean}},emits:["update:modelValue"],setup(g,{emit:e}){const t=g,a=Je({get(){return t.modelValue},set(i){e("update:modelValue",i)}});return(i,o)=>{const r=S("RadioButton");return w(),T("div",dt,[l("h3",ut,ae(g.title),1),(w(!0),T(Ce,null,De(g.items,(n,h)=>(w(),T("div",{class:"field-radiobutton m-2 mt-2",key:h+n.label},[u(r,{modelValue:N(a),"onUpdate:modelValue":o[0]||(o[0]=v=>Ge(a)?a.value=v:null),id:n.label,name:g.title,value:n.label,disabled:g.disabled,class:"mx-2"},null,8,["modelValue","id","name","value","disabled"]),l("label",{for:n.label},ae(n.label),9,ht)]))),128))])}}}),ft={class:"flex flex-col h-screen w-full"},pt={class:"basis-[5rem] flex-grow-0 flex flex-row bg-dark-400 m-4 cool-shadow overflow-hidden"},mt={class:"flex-1 flex align-middle justify-start items-center pl-4"},gt={class:"flex-0 w-20 items-center flex justify-center"},_t={class:"flex-1 flex flex-col relative bg-dark-400 m-4 cool-shadow overflow-hidden"},wt={class:"absolute left-0 right-0 bottom-0 top-0"},bt=ie({__name:"Drawer",props:{title:null,open:{type:Boolean}},emits:["update:open"],setup(g,{emit:e}){const t=()=>{e("update:open",!1)};return(a,i)=>{const o=S("Button");return w(),T("div",{class:x(["flex-grow-0 w-md h-screen z-50 flex-col overflow-hidden transition-all duration-[400ms] text-light-50 box-content max-w-full <sxl:fixed <sxl:right-0 <sxl:top-0 <sxl:bottom-0",{"!w-0":!g.open}])},[l("div",ft,[l("div",pt,[l("div",mt,[l("h2",null,ae(g.title),1)]),l("div",gt,[u(o,{icon:"pi pi-times",class:"p-button-rounded p-button-text !text-light-50",onClick:t})])]),l("div",_t,[l("div",wt,[Ke(a.$slots,"default",{},void 0,!0)])])])],2)}}});var xt=Ve(bt,[["__scopeId","data-v-3ea764bc"]]);const St={ref:"chatContainer",class:"flex flex-1 h-full flex-col p-4 min-w-[300px]"},yt={ref:"chatInputContainer",class:"inline-flex flex-grow-0 w-full align-center pt-5"},kt=ie({__name:"Chat",props:{modelValue:null},emits:["update:modelValue"],setup(g,{emit:e}){const t=g,a=c(""),i=c(null);function o(){a.value&&(e("update:modelValue",[...t.modelValue,{data:a.value.trim(),own:!0}]),a.value="")}function r(n){n.key==="Enter"&&o()}return I(()=>t.modelValue,n=>{i.value.scrollTop+i.value.offsetHeight==i.value.scrollHeight&&setTimeout(()=>{i.value.scrollTop=i.value.scrollHeight},20)},{deep:!0}),(n,h)=>{const v=S("InputText"),_=S("Button");return w(),T("div",St,[l("div",{ref_key:"chatMessagesContainer",ref:i,class:"flex-1 w-full overflow-auto font-normal text-base break-words pb-4 flex flex-col"},[(w(!0),T(Ce,null,De(g.modelValue,(R,O)=>(w(),T("div",{class:x(["bg-dark-50 max-w-6/10 p-2 px-4 m-2 rounded-lg self-start",{"self-message":R.own}]),key:O},ae(R.data),3))),128))],512),l("div",yt,[u(v,{type:"text",class:"w-full",modelValue:a.value,"onUpdate:modelValue":h[0]||(h[0]=R=>a.value=R),onKeydown:r},null,8,["modelValue"]),u(_,{icon:"pi pi-chevron-right",class:"p-button-rounded p-button-secondary p-button-text",onClick:o})],512)],512)}}});var Ct=Ve(kt,[["__scopeId","data-v-d8289092"]]);class Dt{constructor(e){this._devices=[],this._currentStream=new MediaStream,this._currentScreenStream=new MediaStream,this.defaultConstraints={audio:{autoGainControl:!1,channelCount:1,echoCancellation:!0,latency:0,noiseSuppression:!0,sampleRate:48e3,sampleSize:16},video:{width:{min:640,max:1920},height:{min:400,max:1920},aspectRatio:{min:.2,ideal:16/9},frameRate:{min:10,ideal:60,max:240}}},this._videoLocal=e}get currentDevices(){const e=this.currentVideoTracks,t=this.currentAudioTracks;return this._currentStream?{audio:t[0]&&t[0].label,video:e[0]&&e[0].label}:null}get mediaDevices(){return this._devices}get audioDevices(){return this._devices.filter(e=>e.kind=="audioinput")}get videoDevices(){return this._devices.filter(e=>e.kind=="videoinput")}get currentStream(){return this._currentStream}get currentVideoTracks(){return this._currentStream.getVideoTracks()}get currentVideoCapabilities(){return this.currentStream.getVideoTracks()[0]?this.currentStream.getVideoTracks()[0].getCapabilities():null}get currentAudioTracks(){return this._currentStream.getAudioTracks()}async getMediaDevices(){return this._devices=await navigator.mediaDevices.enumerateDevices(),console.log(this._devices),this._devices}getMediaDeviceByName(e){return e?this._devices.find(t=>t.label==e):null}async getMediaDevicesStream(e=this.defaultConstraints,t=!0){if(navigator&&navigator.mediaDevices)try{if(await this.getMediaDevices(),this.audioDevices.length<=0&&(e.audio=!1),this.videoDevices.length<=0&&(e.video=!1),t){const a=this.getMediaSourcesInfoFromLocalStorage(),i=this.getMediaDeviceByName(a.audio),o=this.getMediaDeviceByName(a.video);i&&(typeof e.audio=="boolean"?e.audio={deviceId:i.deviceId}:(e.audio=e.audio,!e.audio.deviceId&&(e.audio.deviceId=i.deviceId))),o&&(typeof e.video=="boolean"?e.video={deviceId:o.deviceId}:(e.video=e.video,!e.video.deviceId&&(e.video.deviceId=o.deviceId)))}return console.log("constraints",e),this._currentStream=await navigator.mediaDevices.getUserMedia(e),console.log("current stream",this._currentStream.getVideoTracks()[0].getSettings()),this._currentStream}catch(a){return console.log(a),null}return null}async getScreenStream(){if(navigator&&navigator.mediaDevices)try{return this._currentScreenStream=await navigator.mediaDevices.getDisplayMedia({video:!0,audio:!0}),console.log(this._currentScreenStream),await this.stopAndRemoveVideo(),this.currentStream.addTrack(this._currentScreenStream.getVideoTracks()[0]),this._currentScreenStream}catch(e){return console.log(e),null}return null}async initializeLocalStream(e=this.defaultConstraints){const t=await this.getMediaDevicesStream(e);return t?(this.attachStreamToLocalVideo(t),t):null}async stopLocalStream(){this.currentStream.getTracks().forEach(e=>e.stop())}async changeSourceStream(e,t){this.currentDevices.audio!=e&&(await this.stopAndRemoveAudio(),await this.startAudio(e)),this.currentDevices.video!=t&&(await this.stopAndRemoveVideo(),await this.startVideo(t)),this.setMediaSourcesInfoFromLocalStorage(e,t)}attachStreamToLocalVideo(e){e&&(console.log(this._videoLocal),this._videoLocal&&e&&(this._videoLocal.value.srcObject=e),this._videoLocal.value.muted=!0,this._videoLocal.value.play())}async stopAndRemoveVideo(){this.currentVideoTracks.forEach(e=>e.enabled=!1),await new Promise(e=>setTimeout(e,100)),this.currentVideoTracks.forEach(e=>{e.stop(),this._currentStream.removeTrack(e)})}stopAndRemoveAudio(){this.currentAudioTracks.forEach(e=>{e.stop(),this._currentStream.removeTrack(e)})}stopAudio(){this.currentVideoTracks.forEach(e=>e.stop())}stopVideo(){this.currentAudioTracks.forEach(e=>e.stop())}async startVideo(e){const t=this.getMediaDeviceByName(e);let a=!1;t&&(a={...this.defaultConstraints.video,deviceId:t.deviceId}),console.log("videoConstraint startvideo",e,a);let i=await navigator.mediaDevices.getUserMedia({video:a});return this.currentVideoTracks[0]&&this.currentStream.removeTrack(this.currentVideoTracks[0]),this.currentStream.addTrack(i.getVideoTracks()[0]),i}async startAudio(e){const t=this.getMediaDeviceByName(e);let a=!1;t&&(a={...this.defaultConstraints.audio,deviceId:t.deviceId});let i=await navigator.mediaDevices.getUserMedia({audio:a});return this.currentAudioTracks[0]&&this.currentStream.removeTrack(this.currentAudioTracks[0]),this.currentStream.addTrack(i.getAudioTracks()[0]),i}getMediaSourcesInfoFromLocalStorage(){return JSON.parse(localStorage.getItem("mediaSources")||'{"audio":null,"video":null}')}setMediaSourcesInfoFromLocalStorage(e,t){let a=this.getMediaSourcesInfoFromLocalStorage(),i={};e&&(i.audio=e),t&&(i.video=t),localStorage.setItem("mediaSources",JSON.stringify({...a,...i}))}disableVideo(){this.currentVideoTracks.forEach(e=>e.enabled=!1)}enableVideo(){this.currentAudioTracks.forEach(e=>e.enabled=!0)}disableAudio(){this.currentAudioTracks.forEach(e=>e.enabled=!1)}enableAudio(){this.currentAudioTracks.forEach(e=>e.enabled=!0)}}class Vt{constructor(e,t){this._drawing_position={x:0,y:0},this.counter=0,this.videoSource=e,this.canvas=t,this.trainingState=-1,this._trainingdataset=[[],[]],this._handDetector=null,this._drawingModel=null,this._tf=null,this._emptyHand=0,this._prediction_frame_rate=200,this._past_prediction_time=0}configureCanvas(){this._canvas_ctx=this.canvas.getContext("2d"),console.log(this.videoSource.videoWidth,this.videoSource.videoHeight),this._canvas_ctx.canvas.width=this.videoSource.videoWidth,this._canvas_ctx.canvas.height=this.videoSource.videoHeight}async configureHandModel(){const e=await Se(()=>import("./hand-pose-detection.esm-faf4696d.mjs"),["hand-pose-detection.esm-faf4696d.mjs","entry-c501f1fd.mjs","entry.b346064b.css"]),t=e.SupportedModels.MediaPipeHands,a={runtime:"mediapipe",solutionPath:"@mediapipe/hands",modelType:"full",maxHands:1};this._handDetector=await e.createDetector(t,a)}async predictTrainHandPositions(){const e=Date.now();if(e-this._past_prediction_time>1e3/this._prediction_frame_rate){this._past_prediction_time=e,this._handDetector||(this._tf=await Se(()=>import("./tf-0d4000e9.mjs").then(function(i){return i.t}),["tf-0d4000e9.mjs","entry-c501f1fd.mjs","entry.b346064b.css"]),await this.configureHandModel());const a=await this._handDetector.estimateHands(this.videoSource);if(console.log("hand",a),a.length>0){if(this._emptyHand=0,a[0].keypoints3D[3]&&a[0].keypoints3D[8]){let i=a[0].keypoints3D[4].x-a[0].keypoints3D[8].x,o=a[0].keypoints3D[4].y-a[0].keypoints3D[8].y;a[0].keypoints3D[4].z-a[0].keypoints3D[8].z;let r=Math.sqrt(i*i+o*o),n={x:(a[0].keypoints[4].x+a[0].keypoints[8].x)/2,y:(a[0].keypoints[4].y+a[0].keypoints[8].y)/2};console.log("distance",r),a[0].keypoints3D[21]={x:r,y:r,z:r};const h=[];for(let v of[4,8,21])h.push(a[0].keypoints3D[v]);this._drawingModel?this.predictDrawing(this._tf.tensor3d([h.map(_=>[_.x,_.y,_.z])],[1,3,3]))[0]>.5?this.draw(n.x,n.y):this.setDrawingPosition(n.x,n.y):this.trainingState!=-1?(console.log(a[0]),this._trainingdataset[this.trainingState].push(h.map(v=>[v.x,v.y,v.z])),console.log("data collection:",this.trainingState)):await this.trainDrawingModel()}}else this._emptyHand>100&&(this.trainingState==0?(console.log("training state",this.trainingState),await new Promise(i=>setTimeout(()=>{i(!0)},3e3)),this.trainingState=1):this.trainingState==1&&(console.log("training state",this.trainingState),await new Promise(i=>setTimeout(()=>{i(!0)},3e3)),this.trainingState=-1,await this.trainDrawingModel())),this._emptyHand+=1}requestAnimationFrame(this.predictTrainHandPositions.bind(this))}download(e,t,a){var i=document.createElement("a"),o=new Blob([e],{type:a});i.href=URL.createObjectURL(o),i.download=t,i.click()}async trainDrawingModel(e=!1){const i=this._tf.train.adam(.01);if(e)this._drawingModel=this._tf.sequential(),this._drawingModel.add(this._tf.layers.dense({units:10,inputShape:[22,3],activation:"relu"})),this._drawingModel.add(this._tf.layers.flatten()),this._drawingModel.add(this._tf.layers.dense({units:2,activation:"softmax",bias:!0}));else{const r="/models/v9/";this._drawingModel=await this._tf.loadLayersModel(r+"drawing-model.json")}this._drawingModel.compile({loss:"categoricalCrossentropy",optimizer:i,metrics:["accuracy"]});let o=this._trainingdataset[0].length;if(this._trainingdataset[1].length<o&&(o=this._trainingdataset[1].length),this._trainingdataset[0]=this._trainingdataset[0].slice(0,o),this._trainingdataset[1]=this._trainingdataset[1].slice(0,o),this._tf.util.shuffle(this._trainingdataset[0]),this._tf.util.shuffle(this._trainingdataset[1]),console.log(this._trainingdataset[0]),console.log(this._trainingdataset[1]),o>0){this.download(JSON.stringify(this._trainingdataset),"training-dataset.json","application/json");const r=this._tf.tensor3d([...this._trainingdataset[0],...this._trainingdataset[1]]),n=this._tf.tensor([...this._trainingdataset[0].map(h=>[0,1]),...this._trainingdataset[1].map(h=>[1,0])]);await this._drawingModel.fit(r,n,{epochs:200,callbacks:{onEpochEnd:async(h,v)=>{console.log(`Epoch ${h}: loss = ${v.loss}`)}}}),await this._drawingModel.save("downloads://drawing-model")}}predictDrawing(e){return this._drawingModel.predict(e).dataSync()}getImgFromSourceVideo(){const e=document.createElement("canvas"),t=e.getContext("2d");t.drawImage(this.videoSource,0,0,this.videoSource.videoWidth,this.videoSource.videoHeight);const a=t.getImageData(0,0,this.videoSource.videoWidth,this.videoSource.videoHeight);return e.remove(),a}async start(){this._past_prediction_time=Date.now(),this.predictTrainHandPositions(),this.configureCanvas()}setDrawingPosition(e,t){this._drawing_position.x=e,this._drawing_position.y=t}draw(e,t){this._canvas_ctx.beginPath(),this._canvas_ctx.strokeStyle="#c0392b",this._canvas_ctx.lineWidth=5,this._canvas_ctx.lineCap="round",this._canvas_ctx.moveTo(this._drawing_position.x,this._drawing_position.y),this.setDrawingPosition(e,t),this._canvas_ctx.lineTo(this._drawing_position.x,this._drawing_position.y),this._canvas_ctx.stroke(),console.log("draw",e,t),this.counter+=1}}class te{constructor(e,t,a,i,o){this._localCandidates=[],this._remoteCandidates=[],this._videoChatSendStream=new MediaStream,this._videoChatSenders={},this._receiveStreams={},this._dataChannels={},this._websocket=null,this._signalingFromWebsocket=!1,this._connected=!1,this._state="",this.websocket_configuration={address:"wss://skynet.sytes.net:5355/ws/"},this.configuration={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"turn:skynet.sytes.net:5349",username:"guest",credential:"&!bYELZK$&X^n5Tm#bKu6bQe"}]},this.pc=new RTCPeerConnection(this.configuration),this._onTrack=t,this._onDataChannel=a,this._writeOnChat=i,this._writeOnOffer=o,this._mediaSourcesHandler=e,this.pc.onicecandidate=r=>{if(r.candidate)this._localCandidates.push(r.candidate);else{const n={sdp:this.pc.localDescription,candidate:this._localCandidates},h=ye.compressToEncodedURIComponent(JSON.stringify(n));this._signalingFromWebsocket&&this._websocket?this._websocket.send(h):(o?o(h):console.log(h),navigator.clipboard.writeText(h))}},this.pc.ontrack=r=>{console.log("got track",r),r.streams.forEach(n=>{n.id in this._receiveStreams||(this._receiveStreams[n.id]=n)}),console.log("got track settings",r.streams[0].getTracks()[0].getSettings()),this._onTrack&&this._onTrack(this,r.track,r.streams)},this.pc.ondatachannel=r=>{const n=r.channel;this._dataChannels[n.label]=n,n.label!=="p2p"?this._onDataChannel&&this._onDataChannel(this,this._dataChannels[n.label]):this.p2pDataChannelInitialization(n)},this.pc.oniceconnectionstatechange=r=>{console.log(this.pc.iceConnectionState)},this.pc.onnegotiationneeded=r=>{console.log("negotiation needed"),this.createOffer().then(n=>{this._dataChannels.p2p.send(JSON.stringify({sdp:n}))})},this.pc.onsignalingstatechange=r=>{console.log("signaling state: "+this.pc.signalingState),this._state=String(this.pc.signalingState)}}async createOffer(){console.log("create offer");const e=await this.pc.createOffer();return await this.pc.setLocalDescription(e),e}async createInitialOffer(){return this._localCandidates=[],this.attachDataChannel(),await this.createOffer()}_generateUUID(){var e=new Date().getTime(),t=typeof performance!="undefined"&&performance.now&&performance.now()*1e3||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var i=Math.random()*16;return e>0?(i=(e+i)%16|0,e=Math.floor(e/16)):(i=(t+i)%16|0,t=Math.floor(t/16)),(a==="x"?i:i&3|8).toString(16)})}_createWebsocket(e,t=0){return new Promise(async function(a,i){e||(e=this._generateUUID()),this._websocket=new WebSocket(this.websocket_configuration.address+e),this._websocket.onopen=()=>{a(e)},this._websocket.onmessage=async o=>{o.data.startsWith("/get")?(this._signalingFromWebsocket=!0,this.createInitialOffer()):(this._signalingFromWebsocket=!0,this.createAnswerFromString(o.data))},this._websocket.onclose=o=>{console.log("websocket closed")},this._websocket.onerror=o=>{this._websocket=null,a(null)}}.bind(this))}async websocketGenerateLink(){return await this._createWebsocket()}async websocketConsumeLink(e){return await this._createWebsocket(e)}async close(){this.pc.close(),this._websocket&&this._websocket.close(1e3,"close")}async createAnswerFromString(e){const t=ye.decompressFromEncodedURIComponent(e);t&&(e=t),await this.createAnswer(JSON.parse(e))}async createAnswer(e){let t=null;if(e.sdp){const a=e.sdp;try{if(a.type=="offer")console.log("create answer"),await this.pc.setRemoteDescription(e.sdp),t=await this.pc.createAnswer(),await this.pc.setLocalDescription(t);else if(this.pc.signalingState=="have-local-offer"&&await this.pc.setRemoteDescription(e.sdp),this._videoChatSenders.video&&(console.log("video transport state: ",this._videoChatSenders.video),this._videoChatSenders.video.transport.state=="connected")){let i=this._videoChatSenders.video.getParameters();console.log(i),i.encodings[0].scaleResolutionDownBy=1,this._videoChatSenders.video.setParameters(i),console.log("videochatsenders params",this._videoChatSenders.video.getParameters()),console.log("videochatsenders track settings",this._videoChatSenders.video.track.getSettings())}if(e.candidate){await this.pc.setRemoteDescription(e.sdp),console.log("adding candidate"),this._remoteCandidates=e.candidate;for(const i of e.candidate)await this.pc.addIceCandidate(i)}return t}catch(i){return console.log("----------------------",i),null}}return t}attachVideoChatStream(e=this._mediaSourcesHandler.currentStream){console.log("attach video chat stream",e.getTracks());const t=e.getTracks();console.log(this._mediaSourcesHandler),Object.entries(this._videoChatSenders).forEach(([a,i])=>{var r;const o=t.find(n=>n.kind==a);console.log(o),o&&o!=null?(o==null?void 0:o.label)!=((r=i.track)==null?void 0:r.label)&&(i.replaceTrack(o),console.log("replace"+o.label)):(this.pc.removeTrack(i),delete this._videoChatSenders[a])}),t.forEach(a=>{this._videoChatSenders[a.kind]||(this._videoChatSenders[a.kind]=this.pc.addTrack(a,e))}),console.log(this._videoChatSenders.video)}attachDataChannel(e="p2p",t=0){if(!(e in this._dataChannels)){console.log("attach datachannel:"+e);const a=this.pc.createDataChannel(e,{negotiated:e!="p2p",id:t});this._dataChannels[a.label]=a,e!=="p2p"?this._onDataChannel&&this._onDataChannel(this,this._dataChannels[a.label]):this.p2pDataChannelInitialization(this._dataChannels[a.label])}}p2pDataChannelInitialization(e){e.onopen=t=>{if(console.log("p2p is open!"),this._websocket&&this._websocket.close(1e3,"close"),this._connected=!0,this.attachDataChannel("chat",2),this._videoChatSendStream){this.attachVideoChatStream();let a=()=>{this.pc.signalingState!="stable"?setTimeout(()=>a(),100):this.createOffer().then(i=>{this._dataChannels.p2p.send(JSON.stringify({sdp:i}))})};a()}},e.onclose=()=>{console.log("channel close"),this._connected=!1},e.onmessage=async t=>{const a=JSON.parse(t.data),i=await this.createAnswer(a);i&&e.send(JSON.stringify({sdp:i}))}}get dataChannels(){return this._dataChannels}set videochatSendStream(e){this._videoChatSendStream=e}get videochatSendStream(){return this._videoChatSendStream}get remoteStreams(){return this._receiveStreams}get connected(){return this._connected}get state(){return this._state}}const Tt={class:"flex w-full h-screen bg-black"},Mt={class:"flex-1 p-inputgroup py-2"},It={class:"flex-1 p-inputgroup py-2"},Rt={class:"flex-1 p-inputgroup py-2"},Lt={class:"flex-1 p-inputgroup py-2"},At={class:"flex-1 p-inputgroup py-2"},Et={class:"flex-1"},Ot={class:"flex-1 h-screen flex relative bg-black"},zt={key:0,class:"absolute flex justify-center items-center flex-1 h-screen w-screen text-white text-center"},Bt=l("div",{class:"w-80"},[ke(" Some browsers require you to interact with the webpage before reproduce video. "),l("br"),l("br"),ke(" Please click or tap anywhere on this screen to reproduce remote video. ")],-1),Ht=[Bt],Ut={class:"absolute flex m-auto h-screen w-full items-center justify-center"},Ft={class:"flex flex-1 min-w-[350px] flex-col"},Wt={class:"field-checkbox m-9"},Pt=l("label",{for:"video-fullsize",class:"mx-3"},"Fill the screen size",-1),jt={class:"flex flex-1 items-center justify-start ml-5"},$t={class:"flex flex-1 items-center justify-center"},Nt=l("div",{class:"flex flex-1 items-center justify-center"},null,-1),Qt=ie({__name:"videochat",setup(g){let e,t;const a=Qe(),i=Xe(),o=Ye(),r=he([ot(),st()]),n=he(nt());ct({title:"VideoChat",description:"One click videochat",image:"",type:"WebSite",location:o.path});const h=c(null),v=c(null),_=c(null),R=c(null),O=c(!1);let ve;const q=c(!0),oe=c([]),J=c(0),z=c(!1),y=c(!1),k=c(!1),G=c(!1),K=c(!1),se=c(!1),C=c(""),B=he({video:[],audio:[]}),Q=c(!0),ne=c(!1),L=c(),M=c(),A=c(!0),V=c(!0),H=c(!1),le=c(!1),b=c(!1),D=c(!1),re=c(""),ce=c("");let E=c(),U=c({style:"",x:0,y:0});const{copy:Te}=lt(),Me=()=>{y.value?y.value=!1:(J.value=0,k.value==!0?(k.value=!1,setTimeout(()=>y.value=!0,100)):y.value=!0)},Ie=()=>{k.value?k.value=!1:y.value==!0?(y.value=!1,setTimeout(()=>k.value=!0,100)):k.value=!0},Re=async()=>{D.value=!0,V.value?(!z.value&&await e.stopAndRemoveVideo(),V.value=!1):M.value&&(!z.value&&await e.startVideo(M.value),V.value=!0),t&&t.attachVideoChatStream(),D.value=!1},Le=async()=>{D.value=!0,A.value?(await e.stopAndRemoveAudio(),A.value=!1):L.value&&(await e.startAudio(L.value),A.value=!0,t&&t.attachVideoChatStream()),t&&t.attachVideoChatStream(),D.value=!1},Ae=()=>{E.value=rt(v,{initialValue:{x:window.innerWidth-v.value.offsetWidth,y:window.innerHeight-v.value.offsetWidth}})},Ee=c([{label:"Exit",icon:"pi pi-angle-left text-vanilla-yellow ",command:()=>{fe(),i.push("/")}},{label:"Serverless",icon:"pi pi-server",command:()=>{G.value=!0}},{label:"Maximize",icon:"pi pi-window-maximize",command:()=>{b.value&&_.value?_.value.requestFullscreen():h.value.requestFullscreen()}},{label:"Settings",icon:"pi pi-cog",class:"p-button-raised",command:()=>{Ie()}}]);function F(d){oe.value.push(d)}function Oe(d){t&&t.dataChannels.chat&&t.dataChannels.chat.send(d[d.length-1].data)}async function ze(){if(!C.value&&!se.value){if(se.value=!0,console.log(C.value),i.push({path:"/videochat"}),t=new te(e,X,Y,F,Z),!await t.websocketGenerateLink()){a.add({severity:"error",summary:"Error",detail:"Error generating link. Contact the signaling server system administrator.",group:"br",life:3e3});return}let s=await t.websocketGenerateLink();C.value=document.location.href+"?room="+s,i.push({path:"/videochat",query:{room:s}}),se.value=!1}K.value=!0}function Be(){Te(C.value),K.value=!1}function X(d,s,m){_.value&&(ve=m[0],_.value.srcObject=ve,_.value.oncanplay=p=>{_.value.play().catch(()=>{O.value=!0})}),s.kind=="video"&&setTimeout(()=>me(),3e3)}function Y(d,s){s.onopen=async function(m){console.log(this.label+" is open!"),G.value=!1,s.send("hello"),b.value=!0,setTimeout(()=>!E.value&&Ae(),0)},s.onclose=()=>{console.log("channel close"),_.value.srcObject=null,b.value=!1,pe(),ge()},s.onmessage=m=>{console.log(m.data),F({data:m.data,own:!1}),y.value||J.value++}}function fe(){C.value="",i.push({path:"/videochat"}),pe()}function pe(){t&&t.close()}function Z(d){ce.value=d}async function He(){t=new te(e,X,Y,F,Z),await t.createInitialOffer()}async function Ue(){(!t||t.state!="have-local-offer")&&(t=new te(e,X,Y,F,Z)),await t.createAnswerFromString(re.value)}async function Fe(){Q.value=!1,await de(),B.audio=e.audioDevices,B.video=e.videoDevices,Q.value=!0}async function de(){{if(e=new Dt(h),!await e.initializeLocalStream())return V.value=!1,A.value=!1,a.add({severity:"error",summary:"Error",detail:"Error while trying to get the camera. Check the permissions for the camera.",group:"br",life:3e3}),ne.value=!0,null;ne.value=!1,await e.getMediaDevices(),e.currentAudioTracks.length>0&&(A.value=!0),e.currentVideoTracks.length>0&&(V.value=!0),B.audio=e.audioDevices,B.video=e.videoDevices,L.value=e.currentDevices.audio,M.value=e.currentDevices.video,V.value&&setTimeout(()=>{new Vt(h.value,R.value).start()},3e3)}}async function We(){if(Q.value=!1,z.value)await e.stopAndRemoveVideo(),V.value&&await e.startVideo(M.value),t&&t.attachVideoChatStream(),q.value=!0,z.value=!1;else{if(!await e.getScreenStream())return;t&&t.attachVideoChatStream(),q.value=!1,z.value=!0}Q.value=!0}function me(){if(t){const d=n.width/n.height;for(const s in t.remoteStreams)t.remoteStreams[s].getVideoTracks().forEach(m=>{const p=m.getSettings();d<.7&&p.width/p.height>.9?m.applyConstraints({aspectRatio:{ideal:.9}}):m.applyConstraints({aspectRatio:{ideal:null}})})}}async function ge(){C.value&&(t=new te(e,X,Y,F,Z),await t.websocketConsumeLink(o.query.room)||a.add({severity:"error",summary:"Error",detail:"Error while trying to connnect to the signaling server",group:"br",life:3e3}))}const _e=d=>async(s,m)=>{{if(d==="audio"&&!A.value||d==="video"&&!V.value)return null;m&&(D.value=!0,await e.changeSourceStream(L.value,M.value),D.value=!1,t&&t.attachVideoChatStream()),d=="video"&&e.currentVideoCapabilities&&(q.value=!JSON.stringify(e.currentVideoCapabilities.facingMode).includes("environment"))}};I(L,_e("audio")),I(M,_e("video")),I(b,async d=>{d===!0?setTimeout(()=>{H.value=!0},5e3):H.value=!1});let ue=null;I(r,()=>{b.value===!0?(H.value=!1,clearTimeout(ue),ue=setTimeout(()=>{H.value=!0},5e3)):(H.value=!1,clearTimeout(ue))}),I(r[1],()=>{O.value===!0&&_.value.play().then(()=>{O.value=!1})});function we(d=U.value.x,s=U.value.y){const m=n.width-v.value.offsetWidth,p=n.height-v.value.offsetHeight,W=0,P=0;d>m&&(d=m),s>p&&(s=p),d<W&&(d=W),s<P&&(s=P),d<=m&&s<=p&&d>=0&&s>=0&&(U.value={style:"transform: translate3d("+d+"px, "+s+"px, 0px);",x:d,y:s})}return I(E,()=>{we(E.value.x,E.value.y)},{deep:!0}),I(n,()=>{U.value.x+v.value.offsetWidth>=n.width&&we(n.width-v.value.offsetWidth),me()},{deep:!0}),Ze(()=>{(async()=>(await de(),o.query.room&&o.query.room.length>0&&(C.value=document.location.href,ge())))()}),et(()=>{e.stopLocalStream()}),(d,s)=>{const m=S("InputText"),p=S("Button"),W=S("Textarea"),P=S("Dialog"),Pe=S("SpeedDial"),je=S("Toast"),be=vt,$e=S("Checkbox"),xe=xt,Ne=Ct,qe=at("badge");return w(),T("div",Tt,[u(P,{header:"Serverless connection",footer:"",visible:G.value,"onUpdate:visible":s[2]||(s[2]=f=>G.value=f),class:"flex"},{default:j(()=>[l("div",Mt,[u(m,{placeholder:"Introduce offer/answer",modelValue:re.value,"onUpdate:modelValue":s[0]||(s[0]=f=>re.value=f)},null,8,["modelValue"]),u(p,{label:"Go",onClick:Ue})]),l("div",It,[u(p,{label:"Create offer",class:"w-full",onClick:He})]),l("div",Rt,[u(W,{modelValue:ce.value,"onUpdate:modelValue":s[1]||(s[1]=f=>ce.value=f),disabled:"",rows:"5",class:"min-w-[17rem] w-full"},null,8,["modelValue"])])]),_:1},8,["visible"]),u(P,{header:"Share link",footer:"",visible:K.value,"onUpdate:visible":s[4]||(s[4]=f=>K.value=f),class:"flex w-50rem"},{default:j(()=>[l("div",Lt,[u(W,{modelValue:C.value,"onUpdate:modelValue":s[3]||(s[3]=f=>C.value=f),disabled:"",rows:"2",class:"w-[50rem] w-full"},null,8,["modelValue"])]),l("div",At,[u(p,{label:"Copy to clipboard",class:"w-full",onClick:Be})])]),_:1},8,["visible"]),l("div",{ref:"superiorToolBar",class:x(["absolute flex flex-row w-full text-right transition-all duration-400 disable-rounded",{"lg:pr-[400px]":k.value}])},[u(Pe,{radius:140,model:Ee.value,showIcon:"pi pi-bars text-vanilla-yellow",tooltipOptions:{event:null,position:"right"},hideIcon:"pi pi-times text-vanilla-yellow",direction:"down-right",type:"quarter-circle",buttonClass:"p-button-text",class:"up left transform !-translate-x-5 !-translate-y-5 disable-rounded !z-50"},null,8,["model"]),l("div",Et,[b.value?(w(),ee(p,{key:0,icon:"pi pi-comments p-text-secondary",class:"p-button-rounded p-button-text !p-12 up right transform !translate-x-6 !-translate-y-8",onClick:Me},{default:j(()=>[it(l("i",{class:x(["pi pi-comments mr-2 p-text-secondary text-vanilla-yellow",{"hide-badge":J.value==0}]),style:{"font-size":"2rem"}},null,2),[[qe,J.value]])]),_:1})):$("",!0)])],2),l("div",Ot,[O.value?(w(),T("div",zt,Ht)):$("",!0),l("video",{autoplay:"",ref_key:"videoRemote",ref:_,class:x(["flex-1 max-h-screen w-full",{"!object-cover":le.value}])},null,2),l("div",{ref_key:"videoLocalContainer",ref:v,class:x(["absolute flex m-auto h-screen w-full items-center z-30",{"w-[unset]":b.value,"h-1/4":b.value,"transition-all duration-600":N(E)&&!N(E).isDragging}]),style:tt([{"touch-action":"none"},b.value?N(U)&&N(U).style:""])},[l("video",{autoplay:"",ref_key:"videoLocal",ref:h,class:x(["flex-1 w-full max-h-screen max-h-full max-w-full <lg:object-cover",{"transform  rotate-y-180":q.value}])},null,2),l("canvas",{ref_key:"canvasLocal",ref:R,class:"fixed z-50 w-full bg-transparent transform rotate-y-180"},null,512)],6),l("div",Ut,[ne.value&&!b.value?(w(),ee(p,{key:0,icon:"pi pi-camera",label:"Get media devices",class:"p-button-danger m-auto flex-grow-0",onClick:de})):$("",!0)]),u(je,{position:"bottom-left",group:"br"})]),u(xe,{open:k.value,"onUpdate:open":s[8]||(s[8]=f=>k.value=f),class:"w-[400px] disable-rounded",title:"Settings"},{default:j(()=>[l("div",Ft,[u(be,{modelValue:M.value,"onUpdate:modelValue":s[5]||(s[5]=f=>M.value=f),items:B.video,title:"Video devices",disabled:D.value},null,8,["modelValue","items","disabled"]),u(be,{modelValue:L.value,"onUpdate:modelValue":s[6]||(s[6]=f=>L.value=f),items:B.audio,title:"Audio devices",disabled:D.value},null,8,["modelValue","items","disabled"]),l("div",Wt,[u($e,{id:"video-fullsize",modelValue:le.value,"onUpdate:modelValue":s[7]||(s[7]=f=>le.value=f),binary:!0},null,8,["modelValue"]),Pt]),u(p,{icon:"pi pi-camera",label:"Refresh media devices",class:"p-button-danger m-auto flex-grow-0 !absolute bottom-0 right-0 left-0 min-w-[350px] w-full",onClick:Fe})])]),_:1},8,["open"]),u(xe,{open:y.value,"onUpdate:open":s[10]||(s[10]=f=>y.value=f),title:"Chat",class:"w-[470px] disable-rounded"},{default:j(()=>[u(Ne,{modelValue:oe.value,"onUpdate:modelValue":[s[9]||(s[9]=f=>oe.value=f),Oe]},null,8,["modelValue"])]),_:1},8,["open"]),l("div",{ref:"lowerToolBar",class:x(["absolute bottom-10 <sxl:bottom-3 flex flex-row w-full text-center transition-all duration-400 bottom-0 align-center items-center lower-toolbar",{"lg:pr-[400px]":k.value||y.value,hidden:H.value}])},[l("div",jt,[b.value?$("",!0):(w(),ee(p,{key:0,icon:`pi pi-user-plus ${C.value?"pi-spin pi-spinner":""} `,onClick:ze,class:"p-button-rounded p-button-warning lower-toolbar-button"},null,8,["icon"]))]),l("div",$t,[u(p,{icon:"pi pi-desktop",class:x(["p-button-rounded lower-toolbar-button",{"button-disabled":!z.value}]),onClick:We},null,8,["class"]),u(p,{disabled:D.value,icon:"pi pi-bell",class:x(["p-button-rounded lower-toolbar-button",{"button-disabled":!A.value}]),onClick:Le},null,8,["disabled","class"]),u(p,{disabled:D.value,icon:"pi pi-video",class:x(["p-button-rounded lower-toolbar-button",{"button-disabled":!V.value}]),onClick:Re},null,8,["disabled","class"]),b.value?(w(),ee(p,{key:0,icon:"pi pi-phone",onClick:fe,class:"p-button-rounded p-button-danger lower-toolbar-button transform rotate-z-134"})):$("",!0)]),Nt],2)])}}});export{Qt as default};
