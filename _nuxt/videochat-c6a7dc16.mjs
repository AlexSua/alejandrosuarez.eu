import{e as _e,z as Mt,T,o as k,a as V,b as l,t as me,X as $e,Y as Ge,S as u,u as L,p as Je,r as Rt,$ as C,f as r,w as E,_ as Be,ag as je,ah as It,a5 as At,D as Lt,y as pe,ac as te,j as Et,af as zt,Z as $,Q as j,c as ne,k as Ot,ai as Ht,a6 as Wt,a0 as Ue,a1 as Nt,F as Pt}from"./entry-4f915147.mjs";import{_ as Ye}from"./plugin-vue_export-helper-84c1d017.mjs";import{a as Bt}from"./asyncData-43e216d7.mjs";import{b as jt,c as Ut,d as qt,e as Ft,f as $t,g as Gt}from"./index-05642523.mjs";import{u as Jt}from"./useSeo-dff08ce4.mjs";import{q as Yt}from"./query-86b10385.mjs";import"./json-a415cb56.mjs";import"./utils-94b2c048.mjs";const Qt={class:"flex flex-col w-full px-5"},Zt={class:"text-vanilla-yellow border-b-light-50 border-solid border-b-[2.5px]"},Kt=["for"],Xt=_e({__name:"RadioList",props:{title:null,items:null,modelValue:null,disabled:{type:Boolean}},emits:["update:modelValue"],setup(g,{emit:e}){const t=g,a=Mt({get(){return t.modelValue},set(i){e("update:modelValue",i)}});return(i,n)=>{const c=T("RadioButton");return k(),V("div",Qt,[l("h3",Zt,me(g.title),1),(k(!0),V($e,null,Ge(g.items,(d,w)=>(k(),V("div",{class:"field-radiobutton m-2 mt-2",key:w+d.label},[u(c,{modelValue:L(a),"onUpdate:modelValue":n[0]||(n[0]=b=>Je(a)?a.value=b:null),id:d.label,name:g.title,value:d.label,disabled:g.disabled,class:"mx-2"},null,8,["modelValue","id","name","value","disabled"]),l("label",{for:d.label},me(d.label),9,Kt)]))),128))])}}}),ea={class:"flex flex-col h-full w-full"},ta={class:"basis-[4.5rem] flex-grow-0 flex flex-row bg-dark-400 cool-shadow overflow-hidden"},aa={class:"flex-1 flex align-middle justify-start items-center pl-5"},ia={class:"flex-0 w-20 items-center flex justify-center"},sa={class:"flex-1 flex flex-col relative bg-dark-400 cool-shadow overflow-hidden"},oa={class:"absolute left-0 right-0 bottom-0 top-2"},na=_e({__name:"Drawer",props:{title:null,open:{type:Boolean}},emits:["update:open"],setup(g,{emit:e}){const t=()=>{e("update:open",!1)};return(a,i)=>{const n=T("Button");return k(),V("div",{class:C(["flex-grow-0 w-md z-50 flex-col overflow-hidden transition-all duration-[400ms] text-light-50 box-content max-w-full <sxl:fixed <sxl:right-0 <sxl:top-0 <sxl:bottom-0 bottom-0 <sm:w-full",{"!w-0":!g.open}])},[l("div",ea,[l("div",ta,[l("div",aa,[l("h2",null,me(g.title),1)]),l("div",ia,[u(n,{icon:"pi pi-times",class:"p-button-rounded p-button-text !text-light-50",onClick:t})])]),l("div",sa,[l("div",oa,[Rt(a.$slots,"default",{},void 0,!0)])])])],2)}}});var la=Ye(na,[["__scopeId","data-v-67ddf0f8"]]);const ra={ref:"chatContainer",class:"flex flex-1 h-full flex-col p-4 min-w-[300px]"},ca={ref:"chatInputContainer",class:"inline-flex flex-grow-0 w-full align-center pt-5"},da=_e({__name:"Chat",props:{modelValue:null},emits:["update:modelValue"],setup(g,{emit:e}){const t=g,a=r(""),i=r(null);function n(){a.value&&(e("update:modelValue",[...t.modelValue,{data:a.value.trim(),own:!0}]),a.value="")}function c(d){d.key==="Enter"&&n()}return E(()=>t.modelValue,d=>{i.value.scrollTop+i.value.offsetHeight==i.value.scrollHeight&&setTimeout(()=>{i.value.scrollTop=i.value.scrollHeight},20)},{deep:!0}),(d,w)=>{const b=T("InputText"),z=T("Button");return k(),V("div",ra,[l("div",{ref_key:"chatMessagesContainer",ref:i,class:"flex-1 w-full overflow-auto font-normal text-base break-words pb-4 flex flex-col"},[(k(!0),V($e,null,Ge(g.modelValue,(S,f)=>(k(),V("div",{class:C(["bg-dark-50 max-w-6/10 p-2 px-4 m-2 rounded-lg self-start",{"self-message":S.own}]),key:f},me(S.data),3))),128))],512),l("div",ca,[u(b,{type:"text",class:"w-full",modelValue:a.value,"onUpdate:modelValue":w[0]||(w[0]=S=>a.value=S),onKeydown:c},null,8,["modelValue"]),u(z,{icon:"pi pi-chevron-right",class:"p-button-rounded p-button-secondary p-button-text",onClick:n})],512)],512)}}});var ua=Ye(da,[["__scopeId","data-v-d8289092"]]);class ha{constructor(e){this._devices=[],this._currentStream=new MediaStream,this._currentScreenStream=new MediaStream,this.defaultConstraints={audio:{autoGainControl:!1,channelCount:1,echoCancellation:!0,latency:0,noiseSuppression:!0,sampleRate:48e3,sampleSize:16},video:{width:{min:400},height:{min:400},aspectRatio:{min:0,ideal:16/9},frameRate:{min:10,ideal:60,max:240}}},this._videoLocal=e}get currentDevices(){const e=this.currentVideoTracks,t=this.currentAudioTracks;return this._currentStream?{audio:t[0]&&t[0].label,video:e[0]&&e[0].label}:null}get mediaDevices(){return this._devices}get audioDevices(){return this._devices.filter(e=>e.kind.startsWith("audioinput"))}get audioInputDevices(){return this._devices.filter(e=>e.kind.startsWith("audioinput"))}get videoDevices(){return this._devices.filter(e=>e.kind.startsWith("video"))}get currentStream(){return this._currentStream}get currentVideoTracks(){return this._currentStream.getVideoTracks()}get currentVideoCapabilities(){return this.currentStream.getVideoTracks()[0]?this.currentStream.getVideoTracks()[0].getCapabilities():null}get currentAudioTracks(){return this._currentStream.getAudioTracks()}async getMediaDevices(){return this._devices=await navigator.mediaDevices.enumerateDevices(),console.log(this._devices),this._devices}getMediaDeviceByName(e){return e?this._devices.find(t=>t.label==e):null}async getMediaDevicesStream(e=this.defaultConstraints,t=!0){if(navigator&&navigator.mediaDevices)try{if(await this.getMediaDevices(),this.audioDevices.length<=0&&(e.audio=!1),this.videoDevices.length<=0&&(e.video=!1),t){const a=this.getMediaSourcesInfoFromLocalStorage(),i=this.getMediaDeviceByName(a.audio),n=this.getMediaDeviceByName(a.video);i&&(typeof e.audio=="boolean"?e.audio={deviceId:i.deviceId}:(e.audio=e.audio,!e.audio.deviceId&&(e.audio.deviceId=i.deviceId))),n&&(typeof e.video=="boolean"?e.video={deviceId:n.deviceId}:(e.video=e.video,!e.video.deviceId&&(e.video.deviceId=n.deviceId)))}console.log("constraints",e);try{this._currentStream=await navigator.mediaDevices.getUserMedia(e)}catch{this.defaultConstraints.video=!0,e.video={deviceId:e.video.deviceId},this._currentStream=await navigator.mediaDevices.getUserMedia(e)}return console.log("current stream",this._currentStream.getVideoTracks()[0].getSettings()),this._currentStream}catch(a){return console.log(a),null}return null}async getScreenStream(){if(navigator&&navigator.mediaDevices)try{return this._currentScreenStream=await navigator.mediaDevices.getDisplayMedia({video:{frameRate:{ideal:240}},audio:!0}),await this.stopAndRemoveVideo(),this.currentStream.addTrack(this._currentScreenStream.getVideoTracks()[0]),this._currentScreenStream}catch(e){return console.log(e),null}return null}async initializeLocalStream(e=this.defaultConstraints,t=!0){const a=await this.getMediaDevicesStream(e,t);return a?(this.attachStreamToLocalVideo(a),a):null}async stopLocalStream(){this.currentStream.getTracks().forEach(e=>e.stop())}async changeSourceStream(e,t){if(this.currentDevices.audio!=e){const a=this.currentAudioTracks;await this.startAudio(e),await this.stopAndRemoveAudio(a)}if(this.currentDevices.video!=t){const a=this.currentVideoTracks;await this.startVideo(t),await this.stopAndRemoveVideo(a)}this.setMediaSourcesInfoFromLocalStorage(e,t)}attachStreamToLocalVideo(e){e&&(console.log(this._videoLocal),this._videoLocal&&e&&(this._videoLocal.value.srcObject=e),this._videoLocal.value.muted=!0,this._videoLocal.value.play())}async stopAndRemoveVideo(e=this.currentVideoTracks){e.forEach(t=>t.enabled=!1),await new Promise(t=>setTimeout(t,200)),e.forEach(t=>{t.stop(),this._currentStream.removeTrack(t)})}stopAndRemoveAudio(e=this.currentAudioTracks){e.forEach(t=>{t.stop(),this._currentStream.removeTrack(t)})}stopAudio(){this.currentVideoTracks.forEach(e=>e.stop())}stopVideo(){this.currentAudioTracks.forEach(e=>e.stop())}async startVideo(e){const t=this.getMediaDeviceByName(e);let a=!1;t&&(a={...this.defaultConstraints.video,deviceId:t.deviceId}),console.log("videoConstraint startvideo",e,a);let i=await navigator.mediaDevices.getUserMedia({video:a});return this.currentVideoTracks[0]&&this.currentStream.removeTrack(this.currentVideoTracks[0]),this.currentStream.addTrack(i.getVideoTracks()[0]),i}async startAudio(e){const t=this.getMediaDeviceByName(e);let a=!1;t&&(a={...this.defaultConstraints.audio,deviceId:t.deviceId});let i=await navigator.mediaDevices.getUserMedia({audio:a});return this.currentAudioTracks[0]&&this.currentStream.removeTrack(this.currentAudioTracks[0]),this.currentStream.addTrack(i.getAudioTracks()[0]),i}getMediaSourcesInfoFromLocalStorage(){return JSON.parse(localStorage.getItem("mediaSources")||'{"audio":null,"video":null}')}setMediaSourcesInfoFromLocalStorage(e,t){let a=this.getMediaSourcesInfoFromLocalStorage(),i={};e&&(i.audio=e),t&&(i.video=t),localStorage.setItem("mediaSources",JSON.stringify({...a,...i}))}disableVideo(){this.currentVideoTracks.forEach(e=>e.enabled=!1)}enableVideo(){this.currentAudioTracks.forEach(e=>e.enabled=!0)}disableAudio(){this.currentAudioTracks.forEach(e=>e.enabled=!1)}enableAudio(){this.currentAudioTracks.forEach(e=>e.enabled=!0)}}class qe{constructor(e){this._tf=e,this.trainingdataset=[[],[]]}download(e,t,a="application/json"){var i=document.createElement("a"),n=new Blob([e],{type:a});i.href=URL.createObjectURL(n),i.download=t,i.click()}isModelLoaded(){return this._model!=null}async loadModel(e="/models/v19/drawing-model.json"){this._model=await this._tf.loadLayersModel(e)}async uploadTrainingData(e="/models/v19/"){const t=await fetch(e+"training-dataset.json");return JSON.parse(await t.text())}async predict(e){return this._model.predict(e).dataSync()}async train(e={download:!0,epochs:50,learningRate:.01,validationSplit:.2,shuffle:!0,inputShape:[3,3],neurons:1,yes_output:[1,0],no_output:[0,1]},t=null,a=null){const i=this._tf.train.adam(e.learningRate);if(t?await this.loadModel(t):(this._model=this._tf.sequential(),this._model.add(this._tf.layers.dense({units:e.neurons,inputShape:e.inputShape,activation:"relu"})),this._model.add(this._tf.layers.flatten()),this._model.add(this._tf.layers.dense({units:2,activation:"softmax",bias:!0}))),this._model.compile({loss:"categoricalCrossentropy",optimizer:i,metrics:["accuracy"]}),a){const c=await this.uploadTrainingData(a);this.trainingdataset[0]=[...c[0],...this.trainingdataset[0]],this.trainingdataset[1]=[...c[1],...this.trainingdataset[1]]}let n=this.trainingdataset[0].length;if(this.trainingdataset[1].length<n&&(n=this.trainingdataset[1].length),this.trainingdataset[0]=this.trainingdataset[0].slice(0,n),this.trainingdataset[1]=this.trainingdataset[1].slice(0,n),e.shuffle&&(this._tf.util.shuffle(this.trainingdataset[0]),this._tf.util.shuffle(this.trainingdataset[1])),n>0){e.download&&this.download(JSON.stringify(this.trainingdataset),"training-dataset.json","application/json");const c=this._tf.tensor3d([...this.trainingdataset[0],...this.trainingdataset[1]]),d=this._tf.tensor([...this.trainingdataset[0].map(w=>e.no_output),...this.trainingdataset[1].map(w=>e.yes_output)]);await this._model.fit(c,d,{epochs:e.epochs,callbacks:{onEpochEnd:async(w,b)=>{console.log(`Epoch ${w}: loss = ${b.loss}`)}}}),await this._model.save("downloads://drawing-model")}}}class Fe{constructor(e,t,a=null,i=null){this.ITERATIONS_NUMBER_DRAWING_STATE_CHANGE=10,this._emptyHand=0,this._nonEmptyHand=0,this._numberOfTrainingStates=2,this._stopSignal=!1,this._gestureModels={drawing:null,eraser:null},this._drawing_position={x:0,y:0,timestamp:0},this.videoSource=e,this.canvas=t,this.onDraw=a,this.onDrawingStateChange=i}configureCanvas(e=this.videoSource.videoWidth,t=this.videoSource.videoHeight){this._canvas_ctx=this.canvas.getContext("2d"),this._canvas_ctx.canvas.width=e,this._canvas_ctx.canvas.height=t}async configureVideoboardML(){this._prediction_frame_rate=2e3,this._trainingState=-1,this._past_prediction_time=Date.now(),this._tf=await Be(()=>import("./tf-c7551952.mjs").then(function(i){return i.t}),["tf-c7551952.mjs","entry-4f915147.mjs","entry.6d2d05c4.css"]);const e=await Be(()=>import("./hand-pose-detection.js"),["hand-pose-detection.js","entry-4f915147.mjs","entry.6d2d05c4.css"]),t=e.SupportedModels.MediaPipeHands,a={runtime:"mediapipe",solutionPath:"/@mediapipe/hands",modelType:"full",maxHands:1};this._handDetector=await e.createDetector(t,a),this._gestureModels.drawing=new qe(this._tf),this._gestureModels.eraser=new qe(this._tf),await this._gestureModels.drawing.loadModel("/models/v19/drawing-model.json"),await this._gestureModels.eraser.loadModel("/models/eraser/v1/drawing-model.json")}async predictTrainHandPositions(){const e=Date.now();if(e-this._past_prediction_time>1e3/this._prediction_frame_rate){this._past_prediction_time=e;const a=await this._handDetector.estimateHands(this.videoSource);if(a.length>0&&(this._nonEmptyHand+=1),a.length>0&&a[0].score>.5){if(this._nonEmptyHand>this.ITERATIONS_NUMBER_DRAWING_STATE_CHANGE&&this.onDrawingStateChange&&this.onDrawingStateChange(!0),this._emptyHand=0,a[0].keypoints3D[3]&&a[0].keypoints3D[8]){let i=a[0].keypoints3D[4].x-a[0].keypoints3D[8].x,n=a[0].keypoints3D[4].y-a[0].keypoints3D[8].y;a[0].keypoints3D[4].z-a[0].keypoints3D[8].z;const c=Math.sqrt(i*i+n*n),d={x:(a[0].keypoints[4].x+a[0].keypoints[8].x)/2,y:(a[0].keypoints[4].y+a[0].keypoints[8].y)/2},w={x:(a[0].keypoints[8].x+a[0].keypoints[12].x)/2,y:(a[0].keypoints[8].y+a[0].keypoints[12].y)/2};i=a[0].keypoints[8].x-a[0].keypoints[7].x,n=a[0].keypoints[8].y-a[0].keypoints[7].y;let b=Math.sqrt(i*i+n*n);i=a[0].keypoints3D[8].x-a[0].keypoints3D[12].x,n=a[0].keypoints3D[8].y-a[0].keypoints3D[12].y,a[0].keypoints3D[8].z-a[0].keypoints3D[12].z,Math.sqrt(i*i+n*n)>.03&&(b=Math.sqrt(i*i+n*n)*1e3+b);const z=[],S=[];for(let f of[4,8])z.push(a[0].keypoints3D[f]);z.push({x:c,y:c,z:c});for(let f in a[0].keypoints3D)S.push(a[0].keypoints3D[f]);if(this._gestureModels.drawing.isModelLoaded()){let f=null,p=null;c<.017?f=[.9]:c>.066&&(this._gestureModels.eraser.isModelLoaded()?p=await this._gestureModels.eraser.predict(this._tf.tensor3d([S.map(m=>[m.x,m.y,m.z])],[1,21,3])):this._trainingState in[...Array(this._numberOfTrainingStates).keys()]?(this._numberOfTrainingStates=3,console.log("Training state is "+this._trainingState,S),this._gestureModels.eraser.trainingdataset[this._trainingState].push(S.map(m=>[m.x,m.y,m.z]))):this._trainingState==2&&(console.log("Training"),this._trainingState=-1,await this._gestureModels.eraser.train({download:!0,epochs:50,learningRate:.01,validationSplit:.2,shuffle:!0,inputShape:[21,3],neurons:1,yes_output:[1,0],no_output:[0,1]}))),f&&f[0]>.5?this.canvasPencilAction(d.x,d.y):p&&p[0]>.5?this.canvasPencilAction(w.x,w.y,void 0,void 0,"eraser",b):this.setDrawingPosition(d.x,d.y)}else this._trainingState in[...Array(this._numberOfTrainingStates).keys()]?this._gestureModels.drawing.trainingdataset[this._trainingState].push(z.map(f=>[f.x,f.y,f.z])):this._trainingState==this._numberOfTrainingStates&&(this._trainingState=-1,await this._gestureModels.drawing.train({download:!0,epochs:50,learningRate:.01,validationSplit:.2,shuffle:!0,inputShape:[3,3],neurons:1,yes_output:[1,0],no_output:[0,1]}))}}else this._emptyHand>this.ITERATIONS_NUMBER_DRAWING_STATE_CHANGE&&this.onDrawingStateChange&&this.onDrawingStateChange(!1),this._emptyHand>100?this._trainingState in[...Array(this._numberOfTrainingStates).keys()]&&(console.log("training state",this._trainingState),await new Promise(i=>setTimeout(()=>{i(!0)},3e3)),this._trainingState+=1):this._emptyHand+=1,this._nonEmptyHand=0}this._stopSignal?this._stopSignal=!1:requestAnimationFrame(this.predictTrainHandPositions.bind(this))}async start(){!this._tf&&await this.configureVideoboardML(),this._stopSignal=!1,this.predictTrainHandPositions()}stop(){this._stopSignal=!0}setDrawingPosition(e,t){this._drawing_position.x=e,this._drawing_position.y=t,this._drawing_position.timestamp=Date.now()}canvasPencilAction(e,t,a=this._drawing_position.x,i=this._drawing_position.y,n="draw",c=10,d=!1,w=(S,f,p,m,U,G,Z)=>this.onDraw(S,f,p,m,U,G,Z),b=this.videoSource.videoWidth,z=this.videoSource.videoHeight){(!this._canvas_ctx||this._canvas_ctx.canvas.width!=b||this._canvas_ctx.canvas.height!=z)&&this.configureCanvas(b,z),!d&&Date.now()-this._drawing_position.timestamp>1e3?this.setDrawingPosition(e,t):(this._canvas_ctx.beginPath(),n=="draw"?(this._canvas_ctx.globalCompositeOperation="source-over",this._canvas_ctx.strokeStyle="#c0392b",this._canvas_ctx.lineWidth=5,this._canvas_ctx.lineCap="round",this._canvas_ctx.moveTo(a,i),!d&&this.setDrawingPosition(e,t),this._canvas_ctx.lineTo(e,t),this._canvas_ctx.stroke()):(this._canvas_ctx.globalCompositeOperation="destination-out",this._canvas_ctx.arc(e,t,c,0,Math.PI*2,!1),this._canvas_ctx.fill()),w!=null&&w(e,t,a,i,n,c,{width:this._canvas_ctx.canvas.width,height:this._canvas_ctx.canvas.height}))}}var Qe=(g=>(g[g.disconnected=0]="disconnected",g[g.connecting=1]="connecting",g[g.connected=2]="connected",g))(Qe||{});class va{constructor(e,t,a,i,n,c=null,d=!0){this._sameNetwork=!0,this._localCandidates=[],this._remoteCandidates=[],this._videoChatSendStream=new MediaStream,this._videoChatSenders={},this._receiveStreams={},this._dataChannels={},this._websocket=null,this._websocket_uuid=null,this._signalingFromWebsocket=!1,this._connected=!1,this._state="",this._actions_queue=[],this._polite=!0,this._making_offer=!1,this._was_connecting=!1,this.websocket_configuration={address:"wss://skynet.sytes.net:5355/"},this._stun_servers=[{urls:"stun:stun.services.mozilla.com"}],this._turn_servers=[{urls:"turn:openrelay.metered.ca:443?transport=tcp",username:"openrelayproject",credential:"openrelayproject"}],this.configuration={iceServers:[...this._stun_servers]},d&&(this.configuration.iceServers=[...this.configuration.iceServers,...this._turn_servers]),console.log(this.configuration),this._onTrack=t,this._onDataChannel=a,this._writeOnOffer=i,this._onClose=n,this._mediaSourcesHandler=e,this._reactive_state=c,this._actions_queue=[]}initWebRTCConnection(){this.pc&&(this.pc.close(),this.pc=null),this._remoteSrflxCandidate=void 0,this._sameNetwork=!0,this._dataChannels={},this.pc=new RTCPeerConnection(this.configuration),this.pc.onicecandidate=e=>{if(e.candidate)e.candidate.type=="srflx"&&(this._localSrflxCandidate=e.candidate,console.log("srflx",this._remoteSrflxCandidate,this._localSrflxCandidate),this._remoteSrflxCandidate!=null&&this._localSrflxCandidate.address!=this._remoteSrflxCandidate.address?this._sameNetwork=!1:this._sameNetwork=!0),this._localCandidates.push(e.candidate);else if(e.candidate===null){let t=[];for(const i of this._localCandidates)!this._sameNetwork&&i.type==="host"||t.push(i);const a=this._compressMessage({sdp:this.pc.localDescription,candidate:t});this._localCandidates=[],this._signalingFromWebsocket&&this._websocket?this._websocket.send(a):(this._writeOnOffer?this._writeOnOffer(a):console.log(a),navigator.clipboard.writeText(a))}},this.pc.ontrack=e=>{console.log("got track",e),e.streams.forEach(t=>{t.id in this._receiveStreams||(this._receiveStreams[t.id]=t)}),console.log("got track settings",e.streams[0].getTracks()[0].getSettings()),this._onTrack&&this._onTrack(this,e.track,e.streams)},this.pc.ondatachannel=e=>{const t=e.channel;this._dataChannels[t.label]=t,t.label!=="p2p"?this._onDataChannel&&this._onDataChannel(this,this._dataChannels[t.label]):this.p2pDataChannelInitialization(t)},this.pc.oniceconnectionstatechange=()=>{this.pc.iceConnectionState==="failed"&&(console.log("------------------------------>>>>>>>>>>>>>"),this.pc.restartIce())},this.pc.onconnectionstatechange=e=>{switch(console.log(this.pc.connectionState),this.pc.connectionState){case"new":case"connected":this._was_connecting=!1;break;case"connecting":this._was_connecting=!0;break;case"closed":break;case"failed":this._was_connecting&&(this._polite=!0,this._websocket.send("/restart"),this._was_connecting=!1);case"disconnected":this._onClose&&this._onClose(),this._set_reactive_state(0);break}},this.pc.onnegotiationneeded=async e=>{try{if(console.log("negotiation needed"),this._making_offer=!0,await this.pc.setLocalDescription(),"p2p"in this._dataChannels)if(this._dataChannels.p2p.readyState!="open"){const t=this._dataChannels.p2p.onopen;this._dataChannels.p2p.onopen=function(a){this._dataChannels.p2p.send(JSON.stringify({sdp:this.pc.localDescription})),this._dataChannels.p2p.onopen=t,this._dataChannels.p2p.onopen(a)}.bind(this)}else this._dataChannels.p2p.send(JSON.stringify({sdp:this.pc.localDescription}));this._making_offer=!1}catch(t){console.log(t)}},this.pc.onsignalingstatechange=e=>{this._state=String(this.pc.signalingState)}}async createInitialOffer(){this.initWebRTCConnection(),this.attachDataChannel("p2p",1,!1)}async _configure_custom_quality(){if("video"in this._videoChatSenders){console.log("video transport state: ",this._videoChatSenders.video);let e=this._videoChatSenders.video.getParameters();this._videoChatSenders.video.track.contentHint="motion",e.encodings||(e.encodings=[{}]);for(const t of e.encodings)t.scaleResolutionDownBy=1;e.degradationPreference="maintain-framerate",await this._videoChatSenders.video.setParameters(e),console.log("videochatsenders params",this._videoChatSenders.video.getParameters()),console.log("videochatsenders track settings",this._videoChatSenders.video.track.getSettings())}"audio"in this._videoChatSenders&&(this._videoChatSenders.audio.track.contentHint="speech")}_set_reactive_state(e){this._reactive_state&&e&&(this._reactive_state.value=e)}_compressMessage(e){return je.compressToEncodedURIComponent(JSON.stringify(e))}_sendWebsocketMessage(e){const t=this._compressMessage(e);this._signalingFromWebsocket&&this._websocket&&this._websocket.send(t)}_generateUUID(){var e=new Date().getTime(),t=typeof performance!="undefined"&&performance.now&&performance.now()*1e3||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var i=Math.random()*16;return e>0?(i=(e+i)%16|0,e=Math.floor(e/16)):(i=(t+i)%16|0,t=Math.floor(t/16)),(a==="x"?i:i&3|8).toString(16)})}_createWebsocket(e=this._websocket_uuid,t=0){return console.log("Creating websocket",this._websocket?this._websocket.readyState:null,e),this._websocket&&this._websocket.readyState!=WebSocket.CLOSED&&this._websocket.readyState!=WebSocket.CLOSING?null:new Promise(async function(a,i){(!e||e==null)&&(e=this._generateUUID()),this._websocket=new WebSocket(this.websocket_configuration.address+e),this._websocket_uuid=e,this._websocket.onopen=()=>{a(e)},this._websocket.onmessage=async n=>{if(n.data.startsWith("/"))switch(console.log(n.data),n.data){case"/remote:open":this._signalingFromWebsocket=!0,this._polite=!1,this.createInitialOffer(),this._set_reactive_state(1);break;case"/remote:close":break;case"/restart":this._polite=!1,this.pc.restartIce()}else this._set_reactive_state(1),this._signalingFromWebsocket=!0,await this.createAnswerFromCompressedString(n.data)},this._websocket.onclose=n=>{console.log("websocket closed")},this._websocket.onerror=n=>{console.log("websocket error"+n.message),setTimeout(()=>this._createWebsocket(this._websocket_uuid),5e3),a(null)}}.bind(this))}async websocketGenerateLink(){return await this._createWebsocket()}async websocketConsumeLink(e){return this._websocket_uuid=e,await this._createWebsocket(e)}close(e=!0){this.pc.close(),this._websocket&&e&&this._websocket.close(1e3,"close")}async createAnswerFromCompressedString(e){const t=je.decompressFromEncodedURIComponent(e);return t&&(e=t),await this.createAnswer(JSON.parse(e))}async createAnswer(e){let t=null;const a=[];let i=!1;if(this.pc||this.initWebRTCConnection(),e.sdp){const n=e.sdp;console.log(n.type,e);const c=n.type==="offer"&&(this._making_offer||this.pc.signalingState!=="stable");if(i=!this._polite&&c,i)return t;try{if(n.type=="offer"?(console.log("create answer"),a.push(this.pc.setRemoteDescription(e.sdp),this.pc.setLocalDescription())):a.push(this.pc.setRemoteDescription(e.sdp)),e.candidate){console.log("adding candidate"),console.log("xx",e.candidate);const d=e.candidate.find(w=>w.candidate.includes("typ srflx"));d&&(this._remoteSrflxCandidate=new RTCIceCandidate(d),console.log("srflx",this._remoteSrflxCandidate,this._localSrflxCandidate),this._localSrflxCandidate!=null&&this._remoteSrflxCandidate.address!=this._localSrflxCandidate.address?this._sameNetwork=!1:this._sameNetwork=!0),console.log("Same network? ",this._sameNetwork);for(const w of e.candidate){const b=new RTCIceCandidate(w);!this._sameNetwork&&b.type==="host"||(console.log(w),a.push(this.pc.addIceCandidate(w)))}}return await Promise.all(a),n.type=="offer"&&this.pc.signalingState!="stable"&&(console.log("state",this.pc.signalingState),t=await this.pc.createAnswer()),t=this.pc.localDescription,t}catch(d){return console.log("ERROR:",d),t}}return t}async attachVideoChatStream(e=this._mediaSourcesHandler.currentStream){var a;if(this.pc.connectionState!=null)if(["connected","connecting"].includes(this.pc.connectionState)){if(this.pc.iceGatheringState!=="complete")return null}else return null;console.log("attach video chat stream",e.getTracks());const t=e.getTracks();console.log(this._mediaSourcesHandler);for(const[i,n]of Object.entries(this._videoChatSenders)){const c=t.find(d=>d.kind==i);console.log(c),c&&c!=null?(c==null?void 0:c.label)!=((a=n.track)==null?void 0:a.label)&&(await n.replaceTrack(c),console.log("replace"+c.label)):(this.pc.removeTrack(n),delete this._videoChatSenders[i])}t.forEach(i=>{this._videoChatSenders[i.kind]||(this._videoChatSenders[i.kind]=this.pc.addTrack(i,e))}),console.log(this._videoChatSenders.video),setTimeout(()=>this._configure_custom_quality(),1e3)}attachDataChannel(e="p2p",t=1,a=!0){if(!(e in this._dataChannels)){console.log("attach datachannel:"+e);const i=this.pc.createDataChannel(e,{negotiated:a,id:t});e!=="p2p"?this._onDataChannel&&this._onDataChannel(this,i):this.p2pDataChannelInitialization(i),this._dataChannels[i.label]=i}}addActionToQueue(e){this._actions_queue.push(e)}p2pDataChannelInitialization(e){e.onopen=t=>{console.log("p2p is open!"),this._set_reactive_state(2),this._websocket&&this._websocket.close(1e3,"close"),this._connected=!0,this.attachDataChannel("chat",2,!0),this._mediaSourcesHandler.currentStream&&this.attachVideoChatStream()},e.onclose=async()=>{console.log("channel close"),this._set_reactive_state(0),this._connected=!1},e.onmessage=async t=>{const a=JSON.parse(t.data);await this.createAnswer(a)&&e.send(JSON.stringify({sdp:this.pc.localDescription}))}}get dataChannels(){return this._dataChannels}set videochatSendStream(e){this._videoChatSendStream=e}get videochatSendStream(){return this._videoChatSendStream}get remoteStreams(){return this._receiveStreams}get connected(){return this._connected}get state(){return this._state}set mediaSourcesHandler(e){this._mediaSourcesHandler=e}}const fa={class:"flex w-full h-screen bg-black"},pa={key:0,class:"w-full h-full flex absolute !z-32"},ma=l("div",{class:"flex-1 flex justify-center items-center text-vanilla-yellow pulsate max-h-20"}," Establishing connection... ",-1),_a={class:"flex-1 p-inputgroup py-2"},ga={class:"flex-1 p-inputgroup py-2"},wa={class:"flex-1 p-inputgroup py-2"},ba={class:"blog-wrapper !bg-white !m-0 !p-0 !grid-rows-none !grid-cols-none !min-h-0 !flex"},ya={class:"markdown-body !shadow-none !m-0 !p-0 mt-2 max-w-full"},xa={class:"pt-5"},ka={class:"flex-1 p-inputgroup py-2"},Sa={class:"flex-1 p-inputgroup py-2"},Ca=l("h5",null,"Insert room id:",-1),Da={class:"flex-1 p-inputgroup py-2"},Ta={class:"flex-1 p-inputgroup py-2"},Va={class:"flex-1"},Ma={class:"flex-1 overflow-hidden flex relative bg-black"},Ra={key:0,class:"absolute flex justify-center items-center flex-1 h-screen w-screen text-white text-center"},Ia=l("div",{class:"w-80"},[Ue(" Some browsers require you to interact with the webpage before reproducing video. "),l("br"),l("br"),Ue(" Please click or tap anywhere on this screen to reproduce remote video. ")],-1),Aa=[Ia],La={ref:"videoRemoteContainer",class:"absolute flex m-auto h-screen w-screen items-center z-30 flex justify-center"},Ea={class:"absolute flex m-auto h-screen w-full items-center justify-center"},za={class:"flex flex-1 min-w-[350px] flex-col"},Oa={class:"field-checkbox m-9 mb-2"},Ha=l("label",{for:"local-video-mirror",class:"mx-3"},"Mirroring local video",-1),Wa={class:"field-checkbox m-9 mt-2"},Na=l("label",{for:"turn-server-enabled",class:"mx-3"},"Turn server enabled",-1),Pa={key:0,class:"flex flex-1 items-center justify-start ml-5 !min-w-20"},Ba={class:"flex flex-col bottom-0 absolute"},ja={class:"flex flex-1 items-center justify-center"},Ua={class:"w-[22px] h-[22px] flex justify-center"},qa={xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 490.9 490.9",preserveAspectRatio:"xMidYMid meet",style:{fill:"white",stroke:"white","stroke-width":"10px"}},Fa=l("path",{d:"M245.5 322.9c53 0 96.2-43.2 96.2-96.2V96.2c0-53-43.2-96.2-96.2-96.2s-96.2 43.2-96.2 96.2v130.5c0 53.1 43.2 96.2 96.2 96.2zM173.8 96.2c0-39.5 32.2-71.7 71.7-71.7s71.7 32.2 71.7 71.7v130.5c0 39.5-32.2 71.7-71.7 71.7s-71.7-32.2-71.7-71.7V96.2z"},null,-1),$a=l("path",{d:"M94.4 214.5c-6.8 0-12.3 5.5-12.3 12.3 0 85.9 66.7 156.6 151.1 162.8v76.7h-63.9c-6.8 0-12.3 5.5-12.3 12.3s5.5 12.3 12.3 12.3h152.3c6.8 0 12.3-5.5 12.3-12.3s-5.5-12.3-12.3-12.3h-63.9v-76.7c84.4-6.3 151.1-76.9 151.1-162.8 0-6.8-5.5-12.3-12.3-12.3s-12.3 5.5-12.3 12.3c0 76.6-62.3 138.9-138.9 138.9s-138.9-62.3-138.9-138.9c.2-6.8-5.2-12.3-12-12.3z"},null,-1),Ga=[Fa,$a],Ja=l("div",{class:"flex flex-1 items-center justify-center"},null,-1),ii=_e({__name:"videochat",setup(g){let e,t,a,i;const n=It(),c=At(),d=Lt(),w=pe([jt(),Ut()]),b=pe(qt()),z=pe([b,Ft()]),S=r(!1);Jt({title:"VideoChat",description:"A videochat with one link",image:"",type:"WebSite",location:d.path});const f=r(null),p=r(null),m=r(null),U=r(null),G=r(null),Z=r(!1),O=r(!1);let Ie;const K=r(!0),ae=r(!0),ge=r([]),le=r(0),J=r(!1),H=r(!1),W=r(!1),re=r(!1),ce=r(!1),de=r(!1),ie=r(null),se=r(!0),we=Bt("videochat-info",()=>Yt("/videochat-info").findOne(),"$4vJ9BW9WxA"),be=r(!1),M=r(""),X=pe({video:[],audio:[]}),ue=r(!0),ye=r(!1),q=r(),N=r(),Y=r(!0),P=r(!0),he=r(!1),ee=r(!1),Ze=r(!1),x=r(!1),R=r(!1);let F=r(!0);const xe=r(""),ke=r(""),Ae=r(!1),Se=r(Qe.disconnected);function Ke(){let o=!1;return function(s){(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(s)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(s.substr(0,4)))&&(o=!0)}(navigator.userAgent||navigator.vendor||window.opera),o}{const o=te("videochat-info-displayed");Ae.value=Ke(),o==="true"?se.value=!1:te("videochat-info-displayed","true")}let I=r(),A=r({style:"",x:0,y:0});const{copy:Xe}=$t(),et=()=>{H.value?H.value=!1:(le.value=0,W.value==!0?(W.value=!1,setTimeout(()=>H.value=!0,100)):H.value=!0)},tt=()=>{W.value?W.value=!1:H.value==!0?(H.value=!1,setTimeout(()=>W.value=!0,100)):W.value=!0},at=async()=>{R.value=!0;try{P.value?(!J.value&&await e.stopAndRemoveVideo(),P.value=!1):N.value&&(!J.value&&await e.startVideo(N.value),P.value=!0),t&&t.attachVideoChatStream(),Me()}catch(o){n.add({severity:"error",summary:"Error",detail:o,group:"br",life:3e3})}R.value=!1},it=async()=>{R.value=!0;try{Y.value?(await e.stopAndRemoveAudio(),Y.value=!1):q.value&&(await e.startAudio(q.value),Y.value=!0),t&&t.attachVideoChatStream()}catch(o){n.add({severity:"error",summary:"Error",detail:o,group:"br",life:3e3})}R.value=!1},st=async()=>{he.value?(await a.stop(),he.value=!1,O.value=!1):(await a.start(),he.value=!0)},ot=(o=null,s=null)=>{o=Number(o||p.value.style.width.replace("px","")||p.value.offsetWidth),s=Number(s||p.value.style.height.replace("px","")||p.value.offsetHeight),console.log("enablevideolocaldraggable ",{x:window.innerWidth-o,y:window.innerHeight-s}),I.value=Gt(p,{initialValue:{x:window.innerWidth-o,y:window.innerHeight-s}})},nt=r([{label:"Exit",icon:"pi pi-angle-left text-vanilla-yellow ",command:async()=>{await Ee(),await c.push("/")}},{label:"Serverless",icon:"pi pi-server",command:()=>{re.value=!0}},{label:"Painting mode",icon:"pi pi-pencil active",command:()=>{st()}},{label:"Maximize",icon:"pi pi-window-maximize",command:()=>{x.value&&m.value?m.value.requestFullscreen():f.value.requestFullscreen()}},{label:"Info",icon:"pi pi-info-circle",command:()=>{se.value=!0}},{label:"Settings",icon:"pi pi-cog",command:()=>{tt()}}]);function lt(o){ge.value.push(o)}function rt(o){t&&x.value&&t.dataChannels.chat&&t.dataChannels.chat.send(o[o.length-1].data)}async function ct(){if(!M.value&&!be.value){be.value=!0,console.log(M.value),await c.push({path:"/videochat"}),t=ve();let o=await t.websocketGenerateLink();if(!o){n.add({severity:"error",summary:"Error",detail:"Error generating link. Contact the signaling server system administrator.",group:"br",life:3e3});return}M.value=document.location.href+"?room="+o,await c.push({path:"/videochat",query:{room:o}}),be.value=!1}M.value&&(ce.value=!0)}async function dt(){de.value=!0}async function ut(){ie.value?(t&&t.close(),M.value=document.location.href+"?room="+ie.value,await c.push({path:"/videochat",query:{room:ie.value}}),await Ce(),de.value=!1):n.add({severity:"error",summary:"Error",detail:"You need to introduce a room ID",group:"br",life:3e3})}function ht(){Xe(M.value),ce.value=!1}function vt(o,s,h){m.value&&(Ie=h[0],m.value.srcObject=Ie,m.value.oncanplay=_=>{m.value.play().catch(()=>{Z.value=!0}),Q(G.value,m.value)},m.value.onchange=()=>{i.configureCanvas(m.value.videoWidth,m.value.videoHeight),Q(G.value,m.value)})}function ft(o,s){switch(s.label){case"chat":s.onopen=async function(h){console.log(this.label+" is open!"),re.value=!1,x.value=!0},s.onclose=async()=>{console.log("channel close"),Le()},s.onmessage=h=>{console.log(h.data),lt({data:h.data,own:!1}),H.value||le.value++};break;case"video-board":s.onopen=async function(h){console.log(this.label+" is open!")},s.onclose=()=>{console.log("channel "+this.label+"close")},s.onmessage=h=>{const _=JSON.parse(h.data);i.canvasPencilAction(_.x,_.y,_.px,_.py,_.mode,_.radius,!0,null,_.canvasSize.width,_.canvasSize.height)};break}}function Le(){x.value&&(ze(),m.value.srcObject=null,x.value=!1)}function pt(o,s,h,_,y,D,B){if(t&&x.value){const oe=t.dataChannels["video-board"];oe?oe.readyState=="open"&&oe.send(JSON.stringify({x:o,y:s,px:h,py:_,mode:y,radius:D,canvasSize:B})):(console.log("no video board datachannel"),t.attachDataChannel("video-board",3,!1))}}function mt(o){O.value!=o&&(O.value=o,O.value?(p.value.style.width="",p.value.style.height=""):x.value&&De())}async function Ee(){M.value="",ze(),await c.push({path:"/videochat"})}function ze(o=!0){t&&t.close(o)}function _t(o){ke.value=o}function ve(){return t=new va(e,vt,ft,_t,Le,Se,K.value),t}async function gt(){t=ve(),await t.createInitialOffer()}async function wt(){(!t||t.state!="have-local-offer")&&(t=ve()),await t.createAnswerFromCompressedString(xe.value)}async function bt(){ue.value=!1,e&&(e.stopAndRemoveAudio(),await e.stopAndRemoveVideo()),await fe(),X.audio=e.audioDevices,X.video=e.videoDevices,ue.value=!0}async function fe(){{let o=!0;e?o=!1:e=new ha(f);const s=await e.initializeLocalStream(void 0,o);if(!s)return P.value=!1,Y.value=!1,n.add({severity:"error",summary:"Error",detail:"Error while trying to get the camera. Check the permissions for the camera.",group:"br",life:3e3}),ye.value=!0,null;for(const h of s.getTracks())h.onended=async _=>{await e.stopAndRemoveAudio(),await e.stopAndRemoveVideo(),console.log("track ended"),await fe()};ye.value=!1,e.currentAudioTracks.length>0&&(Y.value=!0),e.currentVideoTracks.length>0&&(P.value=!0),X.audio=e.audioDevices,X.video=e.videoDevices,q.value=e.currentDevices.audio,N.value=e.currentDevices.video,P.value&&(a=new Fe(f.value,U.value,pt,mt),f.value.oncanplay=()=>{Q(U.value,f.value)},f.value.onchange=()=>{i.configureCanvas(f.value.videoWidth,f.value.videoHeight),Q(U.value,f.value)},te("local-video-mirror")==="false"?F.value=!1:F.value=!0),t&&t.attachVideoChatStream()}}async function Oe(){{if(ue.value=!1,J.value)await e.stopAndRemoveVideo(),P.value&&await e.startVideo(N.value),ae.value=!0,J.value=!1;else{let o=await e.getScreenStream();if(o.getVideoTracks()[0].onended=()=>{J.value=!0,Oe()},!o)return;ae.value=!1,J.value=!0}t&&t.attachVideoChatStream()}ue.value=!0}async function Ce(){d.query.room&&d.query.room!=null&&(t=ve(),await t.websocketConsumeLink(d.query.room)||n.add({severity:"error",summary:"Error",detail:"Error while trying to connnect to the signaling server",group:"br",life:3e3}))}const He=o=>async(s,h)=>{if(!x.value)return null;if(console.log(s,h),R.value=!0,s){if(o==="audio"&&!Y.value||o==="video"&&!P.value)return null;try{a.stop(),O.value=!1,await e.changeSourceStream(q.value,N.value),t&&t.attachVideoChatStream()}catch(_){console.log(_.message),o==="audio"?q.value=h:N.value=h,n.add({severity:"error",summary:"Error",detail:s+": "+_,group:"br",life:3e3}),R.value=!1;return}o=="video"&&e.currentVideoCapabilities&&(ae.value=!JSON.stringify(e.currentVideoCapabilities.facingMode).includes("environment"))}else o==="audio"?q.value=null:N.value=null;R.value=!1};function De(o=!1){p.value.style.height=window.innerHeight/4+"px";const s=xt(f.value,p.value);o&&(p.value.style.transform="translate3d("+(window.innerWidth-s.width)+"px,"+(window.innerHeight-s.height)+"px,0)"),p.value.style.width=s.width+"px",p.value.style.height=s.height+"px"}E(q,He("audio")),E(N,He("video")),E(x,async o=>{o===!0?(i=new Fe(m.value,G.value,null),setTimeout(()=>{ee.value=!0},5e3),De(!0)):(ee.value=!1,p.value.style.width="",p.value.style.height="",Ce())});let Te=null;E(w,()=>{x.value===!0?(ee.value=!1,clearTimeout(Te),Te=setTimeout(()=>{ee.value=!0},5e3)):(ee.value=!1,clearTimeout(Te))}),E(w[1],()=>{Z.value===!0&&m.value.play().then(()=>{Z.value=!1})});function Ve(o=A.value.x,s=A.value.y){const h=b.width-p.value.offsetWidth,_=b.height-p.value.offsetHeight,y=0,D=0;o>h&&(o=h),s>_&&(s=_),o<y&&(o=y),s<D&&(s=D),o<=h&&s<=_&&o>=0&&s>=0&&(A.value={style:"transform: translate3d("+o+"px, "+s+"px, 0px);",x:o,y:s})}function Q(o,s){const h=s.videoWidth/s.videoHeight;o.style.maxWidth=window.innerHeight*h+"px",o.style.maxHeight=window.innerWidth/h+"px"}function yt(o){o.style.maxWidth="",o.style.maxHeight=""}function xt(o,s){const h=Number(1e7),_=Number(s.style.height.replace("px","")||s.offsetHeight),y=h/_,D=o.videoWidth/o.videoHeight,B={width:h,height:_};return y>D?B.width=_*D:y<D&&(B.height=h/D),B}function Me(){x.value&&!O.value&&De(),A.value.x+p.value.offsetWidth>=b.width&&(Ve(b.width-p.value.offsetWidth,A.value.y),I.value&&(I.value.x=A.value.x)),A.value.y+p.value.offsetHeight>=b.height&&(Ve(A.value.x,b.height-p.value.offsetHeight),I.value&&(I.value.y=A.value.y)),Q(U.value,f.value),Q(G.value,m.value)}E(I,()=>{Ve(I.value.x,I.value.y)},{deep:!0});let Re=null;E(z,()=>{S.value=!0,Re&&clearTimeout(Re),Me(),Re=setTimeout(function(){Me(),S.value=!1},1e3)},{deep:!0}),E(F,o=>{te("local-video-mirror",String(o))}),E(Se,o=>{console.log("Connection state: "+String(o))}),E(K,o=>{te("turn-server-enabled",String(o))});function kt(){te("turn-server-enabled")==="false"?K.value=!1:K.value=!0}return Et(()=>{kt(),p.value.ontransitionend=()=>{x.value&&!O.value&&!I.value&&ot(),Q(U.value,f.value)},p.value.ontransitionstart=()=>{x.value&&!O.value&&yt(U.value)},(async()=>(await fe(),d.query.room&&d.query.room.length>0&&(M.value=document.location.href,await Ce())))()}),zt(()=>{e.stopLocalStream()}),(o,s)=>{const h=T("ProgressBar"),_=T("InputText"),y=T("Button"),D=T("Textarea"),B=T("Dialog"),oe=Nt,St=Pt,Ct=T("SpeedDial"),Dt=T("Toast"),We=Xt,Ne=T("Checkbox"),Pe=la,Tt=ua,Vt=Ht("badge");return k(),V("div",fa,[Se.value==1?(k(),V("div",pa,[u(h,{mode:"indeterminate",class:"w-full !h-2 !bg-transparent !z-20 !fixed flex-grow-0"}),ma])):$("",!0),u(B,{header:"Serverless connection",footer:"",visible:re.value,"onUpdate:visible":s[2]||(s[2]=v=>re.value=v),class:"flex"},{default:j(()=>[l("div",_a,[u(_,{placeholder:"Introduce offer/answer",modelValue:xe.value,"onUpdate:modelValue":s[0]||(s[0]=v=>xe.value=v)},null,8,["modelValue"]),u(y,{label:"Go",onClick:wt})]),l("div",ga,[u(y,{label:"Create offer",class:"w-full",onClick:gt})]),l("div",wa,[u(D,{modelValue:ke.value,"onUpdate:modelValue":s[1]||(s[1]=v=>ke.value=v),disabled:"",rows:"5",class:"min-w-[17rem] w-full"},null,8,["modelValue"])])]),_:1},8,["visible"]),u(B,{header:"Videochat info",visible:se.value,"onUpdate:visible":s[4]||(s[4]=v=>se.value=v),class:"flex max-w-4xl w-full",maximizable:!0},{footer:j(()=>[l("div",xa,[u(y,{label:"Ok",icon:"pi pi-check",onClick:s[3]||(s[3]=()=>se.value=!1),autofocus:""})])]),default:j(()=>[l("div",ba,[l("div",ya,[L(we).pending.value?$("",!0):(k(),ne(St,{key:0,value:L(we).data.value},{default:j(()=>[u(oe,{value:L(we).data.value},null,8,["value"])]),_:1},8,["value"]))])])]),_:1},8,["visible"]),u(B,{header:"Share link",footer:"",visible:ce.value,"onUpdate:visible":s[6]||(s[6]=v=>ce.value=v),class:"flex w-50rem"},{default:j(()=>[l("div",ka,[u(D,{modelValue:M.value,"onUpdate:modelValue":s[5]||(s[5]=v=>M.value=v),disabled:"",rows:"2",class:"w-[50rem] w-full"},null,8,["modelValue"])]),l("div",Sa,[u(y,{label:"Copy to clipboard",class:"w-full",onClick:ht})])]),_:1},8,["visible"]),u(B,{header:"Enter room",footer:"",visible:de.value,"onUpdate:visible":s[8]||(s[8]=v=>de.value=v),class:"flex w-30rem"},{default:j(()=>[Ca,l("div",Da,[u(_,{modelValue:ie.value,"onUpdate:modelValue":s[7]||(s[7]=v=>ie.value=v),rows:"1",class:"w-[50rem] w-full"},null,8,["modelValue"])]),l("div",Ta,[u(y,{label:"Enter room",class:"w-full",onClick:ut})])]),_:1},8,["visible"]),l("div",{ref:"superiorToolBar",class:C(["absolute flex flex-row w-full text-right transition-all duration-400 disable-rounded",{"lg:pr-[400px]":W.value}])},[u(Ct,{radius:190,model:nt.value,showIcon:"pi pi-bars text-vanilla-yellow",tooltipOptions:{event:null,position:"right"},hideIcon:"pi pi-times text-vanilla-yellow",direction:"down-right",type:"quarter-circle",buttonClass:"p-button-text",class:C(["video-options-dial up left transform !-translate-x-5 !-translate-y-5 disable-rounded !z-50",{"pencil-active":he.value}])},null,8,["model","class"]),l("div",Va,[x.value?(k(),ne(y,{key:0,icon:"pi pi-comments p-text-secondary",class:"p-button-rounded p-button-text !p-12 up right transform !translate-x-6 !-translate-y-8",onClick:et},{default:j(()=>[Wt(l("i",{class:C(["pi pi-comments mr-2 p-text-secondary text-vanilla-yellow",{"hide-badge":le.value==0}]),style:{"font-size":"2rem"}},null,2),[[Vt,le.value]])]),_:1})):$("",!0)])],2),l("div",Ma,[Z.value?(k(),V("div",Ra,Aa)):$("",!0),l("div",La,[l("video",{autoplay:"",ref_key:"videoRemote",ref:m,class:C(["flex-1 !max-h-full !max-w-full",{"!object-cover":Ze.value}])},null,2),l("canvas",{ref_key:"canvasRemote",ref:G,class:"absolute z-31 bg-transparent transform self-center w-full h-full"},null,512)],512),l("div",{ref_key:"videoLocalContainer",ref:p,class:C(["absolute flex m-auto resize items-center z-30 flex justify-center h-screen w-screen max-h-screen max-w-screen transition-all duration-600 left-0 top-0",{"!duration-0":L(I)&&L(I).isDragging||S.value,"!hidden":!P.value}]),style:Ot([{"touch-action":"none"},x.value&&!O.value?L(A)&&L(A).style:""])},[l("video",{autoplay:"",ref_key:"videoLocal",ref:f,class:C(["flex-1 max-h-screen max-w-screen",{"!max-h-full !max-w-full":x.value&&!O.value,"!transform  !rotate-y-180":ae.value&&L(F)}])},null,2),l("canvas",{ref_key:"canvasLocal",ref:U,class:C(["absolute z-31 bg-transparent transform self-center w-full h-full",{"!transform  !rotate-y-180":ae.value&&L(F)}])},null,2)],6),l("div",Ea,[ye.value&&!x.value?(k(),ne(y,{key:0,icon:"pi pi-camera",label:"Get media devices",class:"p-button-danger m-auto flex-grow-0",onClick:fe})):$("",!0)]),u(Dt,{position:"bottom-left",group:"br"})]),u(Pe,{open:W.value,"onUpdate:open":s[13]||(s[13]=v=>W.value=v),class:"w-[400px] disable-rounded",title:"Settings"},{default:j(()=>[l("div",za,[u(We,{modelValue:N.value,"onUpdate:modelValue":s[9]||(s[9]=v=>N.value=v),items:X.video,title:"Video devices",disabled:R.value},null,8,["modelValue","items","disabled"]),u(We,{modelValue:q.value,"onUpdate:modelValue":s[10]||(s[10]=v=>q.value=v),items:X.audio,title:"Audio devices",disabled:R.value},null,8,["modelValue","items","disabled"]),l("div",Oa,[u(Ne,{id:"local-video-mirror",modelValue:L(F),"onUpdate:modelValue":s[11]||(s[11]=v=>Je(F)?F.value=v:F=v),binary:!0},null,8,["modelValue"]),Ha]),l("div",Wa,[u(Ne,{id:"turn-server-enabled",modelValue:K.value,"onUpdate:modelValue":s[12]||(s[12]=v=>K.value=v),binary:!0},null,8,["modelValue"]),Na]),u(y,{icon:"pi pi-camera",label:"Refresh media devices",class:"p-button-danger m-auto flex-grow-0 !absolute bottom-0 right-0 left-0 min-w-[350px] w-full",onClick:bt})])]),_:1},8,["open"]),u(Pe,{open:H.value,"onUpdate:open":s[15]||(s[15]=v=>H.value=v),title:"Chat",class:"w-[470px] disable-rounded"},{default:j(()=>[u(Tt,{modelValue:ge.value,"onUpdate:modelValue":[s[14]||(s[14]=v=>ge.value=v),rt]},null,8,["modelValue"])]),_:1},8,["open"]),l("div",{ref:"lowerToolBar ",class:C(["absolute bottom-10 <sxl:bottom-3 bottom-0 lower-toolbar w-full justify-center transition-all duration-400",{"lg:pr-[400px]":W.value||H.value,hidden:ee.value}])},[x.value?$("",!0):(k(),V("div",Pa,[l("div",Ba,[u(y,{icon:"pi pi-sign-in",onClick:dt,class:"p-button-rounded p-button-warning lower-toolbar-button"}),u(y,{icon:`pi pi-user-plus ${M.value?"pi-spin pi-spinner":""} `,onClick:ct,class:"p-button-rounded p-button-warning lower-toolbar-button"},null,8,["icon"])])])),l("div",ja,[Ae.value?$("",!0):(k(),ne(y,{key:0,icon:"pi pi-desktop",class:C(["p-button-rounded lower-toolbar-button",{"button-disabled":!J.value}]),onClick:Oe},null,8,["class"])),u(y,{disabled:R.value,icon:"pi",class:C(["p-button-rounded lower-toolbar-button",{"button-disabled":!Y.value}]),onClick:it},{default:j(()=>[l("div",Ua,[(k(),V("svg",qa,Ga))])]),_:1},8,["disabled","class"]),u(y,{disabled:R.value,icon:"pi pi-video",class:C(["p-button-rounded lower-toolbar-button",{"button-disabled":!P.value}]),onClick:at},null,8,["disabled","class"]),x.value?(k(),ne(y,{key:1,icon:"pi pi-phone",onClick:Ee,class:"p-button-rounded p-button-danger lower-toolbar-button transform rotate-z-134"})):$("",!0)]),Ja],2)])}}});export{ii as default};
